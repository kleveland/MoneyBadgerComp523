extends layoutAdmin.pug

block content
    div.container-fluid
      div.quizCreateHeader
        h2.display-4.m-b-2 User List
        div.row
            div.col.mx-1
                table.table.table-hover.tablesorter#userTable
                    thead
                        tr
                            th(scope="col") #
                            th(scope="col") Name 
                              span(class="glyphicon glyphicon-sort")
                            th(scope="col") Onyen 
                              span(class="glyphicon glyphicon-sort")
                            th(scope="col") PID 
                              span(class="glyphicon glyphicon-sort")
                            th(scope="col") Group 
                              span(class="glyphicon glyphicon-sort")
                            th(scope="col") Section 
                              span(class="glyphicon glyphicon-sort")
                            th(scope="col") Change Section
                            th(scope="col") Closed Quizzes
                            th(scope="col") Open Quizzes
                    tbody
                        each val, index in users
                            tr
                                th(scope="row").align-middle=(index+1)
                                td.align-middle=val.first_name + " " + val.last_name
                                td.align-middle=val.onyen
                                td(id="pid").align-middle=val.pid
                                td.align-middle=val.type
                                td(id="secName").align-middle=val.name
                                td.align-middle
                                    div.dropdown
                                        button(type="button" data-toggle="dropdown").btn.btn-primary.dropdown-toggle Change Section
                                        div.dropdown-menu(id=val.pid)
                                            h6.dropdown-header Click to Change Section
                                            each val, index in sections
                                                a(href="#" class="sec" id=val.id).dropdown-item=val.name
                                            script(type='text/javascript').
                                                $(".sec").unbind().click(function() {
                                                    console.log("section clicked");
                                                    let dat = {
                                                        pid: $(this).parent().attr("id"),
                                                        section: $(this).attr("id")
                                                    }
                                                    let setVal = $(this).text();
                                                    let changeVal = $(this).parent().parent().parent().siblings("#secName");
                                                    console.log(dat);
                                                    console.log(changeVal);
                                                    $.post("/admin/updateSec", dat).done(function(val) {
                                                        console.log("Posting done.");
                                                        changeVal.html(setVal);
                                                        $("#userTable").trigger("updateCell",[changeVal[0], true, () => {
                                                            console.log("updated cell.");
                                                        }]);
                                                    });
                                                })
                                - let quiz_arr = val.closed_quiz
                                td.align-middle
                                    div.dropdown
                                        button(type="button" data-toggle="dropdown").btn.btn-danger.dropdown-toggle Closed Quizzes
                                        div.dropdown-menu.open_quiz_but
                                            h6.dropdown-header Click to Open Quiz
                                            if quiz_arr.length >= 1
                                                each val, index in quiz_arr
                                                    a(href="#" class="openquiz" id=val.quiz_id).dropdown-item=val.quiz_name
                                            else
                                                a(href="#").dropdown-item No Closed Quizzes
                                - quiz_arr = val.open_quiz
                                td.align-middle
                                    div.dropdown
                                        button(type="button" data-toggle="dropdown").btn.btn-success.dropdown-toggle Open Quizzes
                                        div.dropdown-menu.close_quiz_but
                                            h6.dropdown-header Click to Close Quiz
                                            if quiz_arr.length >= 1
                                                each val, index in quiz_arr
                                                    a(href="#" class="closequiz" id=val.quiz_id).dropdown-item=val.quiz_name
                                            else
                                                a(href="#").dropdown-item No Open Quizzes

            script(type='text/javascript').
                $(document).ready(function() {
                    $("#userTable").tablesorter( {sortList: [[0,0], [1,0]]} );
                    $(document).on("click", ".openquiz", function() {
                        console.log("Open quiz", $(this).attr("id"));
                        let el = $(this);
                        console.log($(this).parent().parent().parent().siblings("#pid").html());
                        $.post("/admin/openquiz", {
                            user: $(this).parent().parent().parent().siblings("#pid").html(),
                            quiz_id: $(this).attr("id")
                        }).done(function() {
                            console.log("Success Open");
                            el.removeClass("openquiz");
                            el.addClass("closequiz");
                            el.appendTo(".close_quiz_but");
                        });
                    })
                    $(document).on("click", ".closequiz", function() {
                        console.log("Close quiz", $(this).attr("id"));
                        let el = $(this);
                        $.post("/admin/closequiz", {
                            user: $(this).parent().parent().parent().siblings("#pid").html(),
                            quiz_id: $(this).attr("id")
                        }).done(function() {
                            console.log("Success Close");
                            el.removeClass("closequiz");
                            el.addClass("openquiz");
                            el.appendTo(".open_quiz_but");
                        });
                    })
                });
